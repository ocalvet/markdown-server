<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Markdown Viewer</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/styles/github.min.css" id="hljs-light">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/styles/github-dark.min.css" id="hljs-dark" disabled>
</head>
<body>
    <header>
        <div class="header-container">
            <div class="header-left">
                <button id="sidebarToggle" class="sidebar-toggle" aria-label="Toggle sidebar">
                    <span class="toggle-icon">‚ò∞</span>
                </button>
                <a href="index.html" class="logo-link" title="Home">
                    <img src="logo.svg" alt="Markdown Server" class="logo header-logo">
                </a>
                <a href="index.html" class="title-link" title="Go to home">
                    <h1 id="fileName">Loading...</h1>
                </a>
            </div>
            <div class="header-right">
                <button id="searchToggle" class="search-toggle" aria-label="Search" title="Search (Ctrl+K)">
                    <span class="search-icon">üîç</span>
                </button>
                <button id="themeToggle" class="theme-toggle" aria-label="Toggle theme">
                    <span class="theme-icon">‚óê</span>
                </button>
            </div>
        </div>
    </header>

    <div class="layout">
        <aside id="sidebar" class="sidebar">
            <div class="sidebar-header">
                <a href="files.html" class="home-link">üìÅ Files</a>
            </div>
            <nav id="sidebarNav" class="sidebar-nav">
                <div class="loading">Loading files...</div>
            </nav>
        </aside>

        <main class="main-content">
            <div id="breadcrumb" class="breadcrumb"></div>
            <article id="content" class="markdown-content">
                <div class="loading">Loading content...</div>
            </article>
        </main>
    </div>

    <div id="searchModal" class="search-modal" style="display: none;">
        <div class="search-backdrop"></div>
        <div class="search-container">
            <div class="search-header">
                <div class="search-input-wrapper">
                    <span class="search-input-icon">üîç</span>
                    <input type="text" id="searchInput" class="search-input" placeholder="Search files and content..." autocomplete="off">
                    <button id="searchClear" class="search-clear" style="display: none;">‚úï</button>
                </div>
                <button id="searchClose" class="search-close" aria-label="Close search">‚úï</button>
            </div>
            <div id="searchResults" class="search-results">
                <div class="search-empty">
                    <p>Type to search across all markdown files</p>
                    <p class="search-hint">Press <kbd>Esc</kbd> to close</p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/12.0.0/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mermaid/11.0.2/mermaid.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/7.0.0/fuse.min.js"></script>
    <script>
        const API_BASE = window.location.origin;

        function initTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            updateHighlightTheme(savedTheme);
        }

        function updateHighlightTheme(theme) {
            const lightTheme = document.getElementById('hljs-light');
            const darkTheme = document.getElementById('hljs-dark');

            if (theme === 'dark') {
                lightTheme.disabled = true;
                darkTheme.disabled = false;
            } else {
                lightTheme.disabled = false;
                darkTheme.disabled = true;
            }
        }

        document.getElementById('themeToggle').addEventListener('click', () => {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            updateHighlightTheme(newTheme);
        });

        document.getElementById('sidebarToggle').addEventListener('click', (e) => {
            e.stopPropagation();
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('sidebar-open');
        });

        document.addEventListener('click', (e) => {
            const sidebar = document.getElementById('sidebar');
            const sidebarToggle = document.getElementById('sidebarToggle');

            if (window.innerWidth <= 768 &&
                sidebar.classList.contains('sidebar-open') &&
                !sidebar.contains(e.target) &&
                !sidebarToggle.contains(e.target)) {
                sidebar.classList.remove('sidebar-open');
            }
        });

        function renderFileTree(files, container, level = 0, currentFilePath = '') {
            files.forEach(file => {
                if (file.isDir) {
                    const folderItem = document.createElement('div');
                    folderItem.className = 'sidebar-folder';
                    folderItem.style.paddingLeft = `${level * 12}px`;

                    const folderHeader = document.createElement('div');
                    folderHeader.className = 'folder-header';
                    folderHeader.innerHTML = `<span class="folder-toggle">‚ñ∏</span> <span class="folder-icon">üìÅ</span> ${file.name}`;
                    folderItem.appendChild(folderHeader);

                    const folderContent = document.createElement('div');
                    folderContent.className = 'folder-content';
                    folderContent.style.display = 'none';
                    folderItem.appendChild(folderContent);

                    // Check if this folder contains the current file
                    const containsCurrentFile = currentFilePath.startsWith(file.path + '/');

                    if (containsCurrentFile) {
                        folderContent.style.display = 'block';
                        folderHeader.querySelector('.folder-toggle').textContent = '‚ñæ';
                    }

                    folderHeader.addEventListener('click', () => {
                        const isOpen = folderContent.style.display === 'block';
                        folderContent.style.display = isOpen ? 'none' : 'block';
                        folderHeader.querySelector('.folder-toggle').textContent = isOpen ? '‚ñ∏' : '‚ñæ';
                    });

                    container.appendChild(folderItem);

                    if (file.children && file.children.length > 0) {
                        renderFileTree(file.children, folderContent, level + 1, currentFilePath);
                    }
                } else {
                    const fileItem = document.createElement('a');
                    fileItem.href = `viewer.html?file=${encodeURIComponent(file.path)}`;
                    fileItem.className = 'sidebar-file';
                    fileItem.style.paddingLeft = `${level * 12 + 20}px`;
                    fileItem.title = file.name;
                    fileItem.innerHTML = `<span class="file-icon">üìÑ</span><span class="sidebar-file-name">${file.name}</span>`;

                    const urlParams = new URLSearchParams(window.location.search);
                    if (file.path === urlParams.get('file')) {
                        fileItem.classList.add('active');
                        // Scroll active file into view
                        setTimeout(() => {
                            fileItem.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                        }, 100);
                    }

                    fileItem.addEventListener('click', () => {
                        if (window.innerWidth <= 768) {
                            setTimeout(() => {
                                document.getElementById('sidebar').classList.remove('sidebar-open');
                            }, 100);
                        }
                    });

                    container.appendChild(fileItem);
                }
            });
        }

        async function loadFileTree() {
            try {
                const response = await fetch(`${API_BASE}/api/files`);
                const files = await response.json();

                const container = document.getElementById('sidebarNav');
                container.innerHTML = '';

                // Get current file path from URL
                const urlParams = new URLSearchParams(window.location.search);
                const currentFile = urlParams.get('file') || '';

                if (files.length === 0) {
                    container.innerHTML = '<div class="empty-state">No files found</div>';
                } else {
                    renderFileTree(files, container, 0, currentFile);
                }
            } catch (error) {
                document.getElementById('sidebarNav').innerHTML =
                    '<div class="error">Error loading files</div>';
                console.error('Error loading files:', error);
            }
        }

        function renderBreadcrumb(filePath) {
            const parts = filePath.split('/');
            const breadcrumb = document.getElementById('breadcrumb');
            breadcrumb.innerHTML = parts.map((part, index) => {
                if (index === parts.length - 1) {
                    return `<span class="breadcrumb-current">${part}</span>`;
                }
                return `<span class="breadcrumb-item">${part}</span>`;
            }).join('<span class="breadcrumb-separator">/</span>');
        }

        async function loadMarkdown() {
            const urlParams = new URLSearchParams(window.location.search);
            const filePath = urlParams.get('file');

            if (!filePath) {
                document.getElementById('content').innerHTML =
                    '<div class="error">No file specified</div>';
                return;
            }

            try {
                document.getElementById('fileName').textContent = filePath.split('/').pop();
                renderBreadcrumb(filePath);

                const response = await fetch(`${API_BASE}/api/file/${filePath}`);
                if (!response.ok) throw new Error('File not found');

                const markdown = await response.text();

                marked.setOptions({
                    highlight: function(code, lang) {
                        if (lang && hljs.getLanguage(lang)) {
                            return hljs.highlight(code, { language: lang }).value;
                        }
                        return hljs.highlightAuto(code).value;
                    },
                    breaks: true,
                    gfm: true
                });

                const html = marked.parse(markdown);
                document.getElementById('content').innerHTML = html;

                if (typeof mermaid !== 'undefined') {
                    mermaid.initialize({
                        startOnLoad: true,
                        theme: document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'
                    });
                    await mermaid.run({
                        querySelector: '.language-mermaid'
                    });
                }

            } catch (error) {
                document.getElementById('content').innerHTML =
                    '<div class="error">Error loading file. Please try again.</div>';
                console.error('Error loading markdown:', error);
            }
        }

        function initHotReload() {
            try {
                const eventSource = new EventSource(`${API_BASE}/api/events`);

                eventSource.onmessage = (event) => {
                    if (event.data === 'reload') {
                        console.log('File change detected, reloading content...');
                        loadMarkdown();
                        loadFileTree();
                    }
                };

                eventSource.onerror = (error) => {
                    console.log('Hot reload not available, continuing without it');
                    eventSource.close();
                };

                eventSource.addEventListener('connected', () => {
                    console.log('Hot reload connected');
                });
            } catch (error) {
                console.log('Hot reload not available');
            }
        }

        let searchIndex = [];
        let fuse = null;

        async function buildSearchIndex() {
            try {
                const response = await fetch(`${API_BASE}/api/files`);
                const files = await response.json();

                const indexPromises = [];

                function collectFiles(fileList) {
                    fileList.forEach(file => {
                        if (file.isDir && file.children) {
                            collectFiles(file.children);
                        } else if (!file.isDir) {
                            indexPromises.push(
                                fetch(`${API_BASE}/api/file/${file.path}`)
                                    .then(r => r.text())
                                    .then(content => ({
                                        name: file.name,
                                        path: file.path,
                                        content: content.substring(0, 5000)
                                    }))
                                    .catch(() => null)
                            );
                        }
                    });
                }

                collectFiles(files);
                searchIndex = (await Promise.all(indexPromises)).filter(item => item !== null);

                fuse = new Fuse(searchIndex, {
                    keys: [
                        { name: 'name', weight: 2 },
                        { name: 'path', weight: 1.5 },
                        { name: 'content', weight: 1 }
                    ],
                    threshold: 0.4,
                    includeMatches: true,
                    minMatchCharLength: 2,
                    ignoreLocation: true
                });

                console.log(`Search index built: ${searchIndex.length} files`);
            } catch (error) {
                console.error('Error building search index:', error);
            }
        }

        function openSearch() {
            const modal = document.getElementById('searchModal');
            const input = document.getElementById('searchInput');
            modal.style.display = 'flex';
            input.focus();
            document.body.style.overflow = 'hidden';
        }

        function closeSearch() {
            const modal = document.getElementById('searchModal');
            const input = document.getElementById('searchInput');
            const clearBtn = document.getElementById('searchClear');
            modal.style.display = 'none';
            input.value = '';
            clearBtn.style.display = 'none';
            document.body.style.overflow = '';
            renderSearchResults([]);
        }

        function highlightMatch(text, indices) {
            if (!indices || indices.length === 0) return text;

            let result = '';
            let lastIndex = 0;

            indices.forEach(([start, end]) => {
                result += text.substring(lastIndex, start);
                result += `<mark>${text.substring(start, end + 1)}</mark>`;
                lastIndex = end + 1;
            });

            result += text.substring(lastIndex);
            return result;
        }

        function renderSearchResults(results) {
            const container = document.getElementById('searchResults');

            if (results.length === 0) {
                container.innerHTML = `
                    <div class="search-empty">
                        <p>No results found</p>
                        <p class="search-hint">Try different keywords</p>
                    </div>
                `;
                return;
            }

            const resultHTML = results.map((result, index) => {
                const item = result.item;
                const matches = result.matches || [];

                let nameHTML = item.name;
                let pathHTML = item.path;
                let snippetHTML = '';

                matches.forEach(match => {
                    if (match.key === 'name') {
                        nameHTML = highlightMatch(item.name, match.indices);
                    } else if (match.key === 'path') {
                        pathHTML = highlightMatch(item.path, match.indices);
                    } else if (match.key === 'content' && match.indices.length > 0) {
                        const startIdx = Math.max(0, match.indices[0][0] - 50);
                        const endIdx = Math.min(item.content.length, match.indices[0][1] + 100);
                        let snippet = item.content.substring(startIdx, endIdx);

                        const adjustedIndices = match.indices.map(([s, e]) => [
                            Math.max(0, s - startIdx),
                            Math.min(snippet.length - 1, e - startIdx)
                        ]);

                        snippet = snippet.replace(/\n/g, ' ').trim();
                        snippetHTML = (startIdx > 0 ? '...' : '') +
                                     highlightMatch(snippet, adjustedIndices) +
                                     (endIdx < item.content.length ? '...' : '');
                    }
                });

                if (!snippetHTML && item.content) {
                    snippetHTML = item.content.substring(0, 150).replace(/\n/g, ' ') + '...';
                }

                return `
                    <div class="search-result-item" data-path="${item.path}" tabindex="0">
                        <div class="search-result-name">${nameHTML}</div>
                        <div class="search-result-path">${pathHTML}</div>
                        ${snippetHTML ? `<div class="search-result-snippet">${snippetHTML}</div>` : ''}
                    </div>
                `;
            }).join('');

            container.innerHTML = `
                <div class="search-result-count">${results.length} result${results.length !== 1 ? 's' : ''}</div>
                ${resultHTML}
            `;

            container.querySelectorAll('.search-result-item').forEach(item => {
                item.addEventListener('click', () => {
                    const path = item.dataset.path;
                    window.location.href = `viewer.html?file=${encodeURIComponent(path)}`;
                });

                item.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        item.click();
                    }
                });
            });
        }

        let searchTimeout;
        function performSearch(query) {
            clearTimeout(searchTimeout);

            const clearBtn = document.getElementById('searchClear');
            clearBtn.style.display = query ? 'block' : 'none';

            if (!query || query.length < 2) {
                renderSearchResults([]);
                return;
            }

            searchTimeout = setTimeout(() => {
                if (fuse) {
                    const results = fuse.search(query).slice(0, 20);
                    renderSearchResults(results);
                }
            }, 300);
        }

        document.getElementById('searchToggle').addEventListener('click', openSearch);
        document.getElementById('searchClose').addEventListener('click', closeSearch);
        document.getElementById('searchClear').addEventListener('click', () => {
            document.getElementById('searchInput').value = '';
            document.getElementById('searchClear').style.display = 'none';
            renderSearchResults([]);
            document.getElementById('searchInput').focus();
        });

        document.querySelector('.search-backdrop').addEventListener('click', closeSearch);

        document.getElementById('searchInput').addEventListener('input', (e) => {
            performSearch(e.target.value);
        });

        document.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                e.preventDefault();
                openSearch();
            }

            if (e.key === 'Escape') {
                const modal = document.getElementById('searchModal');
                if (modal.style.display === 'flex') {
                    closeSearch();
                }
            }
        });

        document.getElementById('searchResults').addEventListener('keydown', (e) => {
            const items = Array.from(document.querySelectorAll('.search-result-item'));
            const activeElement = document.activeElement;
            const currentIndex = items.indexOf(activeElement);

            if (e.key === 'ArrowDown') {
                e.preventDefault();
                if (currentIndex < items.length - 1) {
                    items[currentIndex + 1].focus();
                } else if (currentIndex === -1 && items.length > 0) {
                    items[0].focus();
                }
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                if (currentIndex > 0) {
                    items[currentIndex - 1].focus();
                } else if (currentIndex === 0) {
                    document.getElementById('searchInput').focus();
                }
            }
        });

        initTheme();
        loadFileTree();
        loadMarkdown();
        initHotReload();
        buildSearchIndex();
    </script>
</body>
</html>
